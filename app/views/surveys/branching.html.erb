<h2 class="mb-3">Branching for <%= @survey.title %></h2>

<%= form_with url: update_branching_survey_path(@survey), method: :post do %>
  <table class="table" style="width:100%; border-collapse: collapse;">
    <thead>
    <tr>
      <th style="text-align:left; padding:8px; border-bottom:1px solid #ccc;">Question</th>
      <% @roles.each do |role| %>
        <th style="text-align:center; padding:8px; border-bottom:1px solid #ccc;"><%= role %></th>
      <% end %>
    </tr>
    </thead>
    <tbody>
    <% @questions.each do |q| %>
      <tr>
        <td style="padding:8px; border-bottom:1px solid #eee;"><%= q.content %></td>
        <% @roles.each do |role| %>
          <% rule = q.branch_rules.find { |r| r.role == role } %>
          <td style="text-align:center; padding:8px; border-bottom:1px solid #eee;">
            <!-- hidden 0 ensures we send something even if box is unchecked -->
            <input type="hidden" name="visibility[<%= role %>][<%= q.id %>]" value="0" />
            <input type="checkbox"
                   name="visibility[<%= role %>][<%= q.id %>]"
                   value="1"
                   <%= (rule.nil? ? true : rule.visible) ? "checked" : "" %> />
          </td>
        <% end %>
      </tr>
    <% end %>
    </tbody>
  </table>

  <div style="margin-top:16px;">
    <%= submit_tag "Save branching", class: "btn btn-primary" %>
    <%= link_to "Back to survey", @survey, class: "btn btn-secondary", style: "margin-left:8px;" %>
  </div>
<% end %>